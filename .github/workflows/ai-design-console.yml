name: AI Design Console

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  design_request:
    if: contains(github.event.issue.title, 'Design Console')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Git identity
        run: |
          git config user.name "ai-design-bot"
          git config user.email "ai-design-bot@users.noreply.github.com"

      - name: Snapshot site spec
        run: |
          TS=$(date -u +"%Y-%m-%d_%H%M%S")
          SNAP="site/_snapshots/$TS"
          mkdir -p "$SNAP/pages"
          cp -f site/theme.json "$SNAP/theme.json" || true
          cp -f site/nav.json "$SNAP/nav.json" || true
          if ls site/pages/*.json 1> /dev/null 2>&1; then
            cp -f site/pages/*.json "$SNAP/pages/" || true
          fi

      - name: Run Codex (edit /site only)
        uses: openai/codex-action@v1
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          prompt: |
            Follow .github/ai/INSTRUCTIONS.md exactly.

            User request:
            ---
            ${{ github.event.comment.body }}
            ---

            Implement the request by editing ONLY /site files.
            Keep JSON valid.
            Update site/design_plan.md with a clear plain-English report.

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "AI design update"
          title: "AI Design Update"
          body: |
            Generated from a Design Console comment.

            **User request**
            ${{ github.event.comment.body }}

            See `site/design_plan.md` for the report.
          branch: ai/design-update
          delete-branch: true

      - name: Comment back with PR link
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = `${{ steps.cpr.outputs.pull-request-url }}`;
            const msg = prUrl
              ? `✅ PR created: ${prUrl}\n\nOpen it to review diffs + read **site/design_plan.md** for the report.`
              : `⚠️ No PR created (maybe no changes). Check workflow logs.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: msg
            });
